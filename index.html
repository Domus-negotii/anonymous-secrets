<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whispers Online (Local)</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* Custom animation for fading in new secrets */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-100 via-pink-100 to-blue-100 text-gray-800 font-sans p-4 sm:p-8 flex flex-col items-center min-h-screen overflow-x-hidden">

    <!-- Custom Error Message Box (now for generic errors) -->
    <div id="error-message-box" class="hidden fixed top-4 left-1/2 -translate-x-1/2 z-50 p-4 bg-red-500 text-white rounded-lg shadow-xl max-w-sm w-full text-center">
        <p id="error-message-text" class="font-semibold"></p>
        <button onclick="document.getElementById('error-message-box').classList.add('hidden')" class="mt-2 text-sm underline opacity-80 hover:opacity-100">Dismiss</button>
    </div>

    <!-- Main content container with responsive width and centered layout -->
    <div class="w-full max-w-3xl mx-auto my-4 sm:my-8 space-y-8">

        <!-- Header Section -->
        <div class="text-center p-6 bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl border border-gray-200">
            <h1 class="text-5xl font-extrabold mb-2 bg-gradient-to-r from-purple-500 to-pink-500 bg-clip-text text-transparent drop-shadow-lg">
                Whispers Online
            </h1>
            <p class="text-gray-600 text-lg">Share your secret with yourself.</p>
            <div id="whisper-count" class="mt-2 text-sm text-gray-500">
                ✨ Loading whispers...
            </div>
        </div>

        <!-- Confession Form -->
        <form id="confess-form" class="p-6 bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl border border-gray-200">
            <div class="relative">
                <textarea
                    id="secret-input"
                    class="w-full p-4 rounded-xl border-2 border-gray-300 bg-white/50 backdrop-blur-sm text-base text-gray-900 focus:outline-none focus:ring-2 focus:ring-purple-400 focus:border-transparent transition-all duration-200 resize-none placeholder-gray-400"
                    placeholder="What's weighing on your heart? Share it anonymously..."
                    rows="4"
                    required
                    maxLength="500"
                ></textarea>
                <div id="char-counter" class="absolute bottom-2 right-2 text-xs text-gray-500">
                    0/500
                </div>
            </div>
            <button
                id="confess-button"
                type="submit"
                class="w-full mt-4 px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold rounded-xl hover:from-purple-600 hover:to-pink-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all duration-200 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-[1.02] active:scale-[0.98]"
            >
                🤫 Confess Anonymously
            </button>
        </form>

        <!-- Recent Whispers Section -->
        <div>
            <h2 class="text-3xl font-bold mb-6 text-center bg-gradient-to-r from-gray-700 to-gray-900 bg-clip-text text-transparent drop-shadow-sm">
                Recent Whispers
            </h2>
            
            <!-- This is where the secrets will be injected by JavaScript -->
            <div id="secrets-container" class="space-y-6">
                <!-- A loading state while fetching data -->
                <div id="loading-state" class="text-center text-gray-500 py-12">
                  <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-400 mx-auto"></div>
                  <p class="mt-4">Loading whispers...</p>
                </div>

                <!-- This is the new container for the featured whisper -->
                <div id="featured-whisper-container" class="space-y-6 hidden">
                    <h3 class="text-2xl font-bold text-center text-gray-700">💫 Featured Whisper</h3>
                    <div id="featured-whisper-card" class="p-8 bg-purple-200/80 backdrop-blur-sm rounded-2xl shadow-2xl border-4 border-purple-400 scale-[1.02] transform transition-all duration-300">
                        <!-- Featured whisper content will be injected here -->
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="text-center text-gray-500 py-12 hidden">
              <div class="text-6xl mb-4">🤐</div>
              <p class="text-xl">No secrets yet.</p>
              <p class="text-sm mt-2">Be the first to share your whisper!</p>
            </div>
        </div>

        <!-- Rules and Guidelines Section -->
        <div class="p-6 bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl border border-gray-200">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">📜 Guidelines for a Safe Community</h2>
            <ul class="list-disc list-inside space-y-2 text-gray-600">
                <li>Be kind and empathetic in your reactions.</li>
                <li>All whispers are anonymous. Please respect each other's privacy.</li>
                <li>No hate speech, threats, or explicit content.</li>
                <li>This is a safe space for honest sharing.</li>
            </ul>
        </div>

        <!-- Donation and Footer -->
        <div class="text-center text-sm text-gray-500 pt-6 border-t border-gray-300">
            <div class="my-4">
                <!--
                  The PayPal link has been updated with your username 'arccanimo'.
                  The QR code image is also the one you provided earlier.
                -->
                <a href="https://www.paypal.com/paypalme/arccanimo" target="_blank" class="inline-block w-full max-w-[200px] rounded-xl overflow-hidden shadow-lg transition-all duration-300 transform hover:scale-105">
                    <img
                        src="https://raw.githubusercontent.com/Domus-negotii/anonymous-secrets/main/paypal-qr.png.png"
                        alt="PayPal QR Code for donations"
                        class="w-full h-auto object-cover"
                    >
                </a>
                <p class="mt-4 text-sm text-gray-600">Scan or click to support this anonymous platform</p>
            </div>
            <p>💫 All whispers are anonymous and ephemeral</p>
            <p class="mt-1">Share your truth, find your peace</p>
        </div>
    </div>

    <script>
        // Define the data and DOM elements
        const STORAGE_KEY = 'whispers-local-storage';

        const emotions = [
            { emoji: '❤️', label: 'Love' },
            { emoji: '😂', label: 'Laugh' },
            { emoji: '😢', label: 'Sad' },
            { emoji: '🙏', label: 'Care' },
            { emoji: '😮', label: 'Surprise' },
        ];

        const confessForm = document.getElementById('confess-form');
        const secretInput = document.getElementById('secret-input');
        const confessButton = document.getElementById('confess-button');
        const secretsContainer = document.getElementById('secrets-container');
        const whisperCountElement = document.getElementById('whisper-count');
        const emptyStateElement = document.getElementById('empty-state');
        const loadingStateElement = document.getElementById('loading-state');
        const charCounterElement = document.getElementById('char-counter');
        const errorBox = document.getElementById('error-message-box');
        const errorText = document.getElementById('error-message-text');
        
        // New elements for the featured whisper
        const featuredWhisperContainer = document.getElementById('featured-whisper-container');
        const featuredWhisperCard = document.getElementById('featured-whisper-card');


        // Function to show a custom error message
        const showErrorMessage = (message) => {
            if (errorBox && errorText) {
                errorText.textContent = message;
                errorBox.classList.remove('hidden');
            }
        };

        // Function to format the timestamp
        const formatTime = (timestamp) => {
            const now = Date.now();
            const diff = now - timestamp;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            return `${Math.floor(diff / 86400000)}d ago`;
        };

        // Function to get whispers from local storage
        const getWhispers = () => {
            try {
                const whispers = localStorage.getItem(STORAGE_KEY);
                return whispers ? JSON.parse(whispers) : [];
            } catch (e) {
                console.error("Could not retrieve whispers from local storage.", e);
                return [];
            }
        };

        // Function to save whispers to local storage
        const saveWhispers = (whispers) => {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(whispers));
            } catch (e) {
                console.error("Could not save whispers to local storage.", e);
                showErrorMessage("Error: Could not save your whisper. Your browser may have local storage disabled or full.");
            }
        };
        
        // Helper function to calculate total reactions for a whisper
        const getTotalReactions = (secret) => {
            return Object.values(secret.reactions || {}).reduce((a, b) => a + b, 0);
        };

        // Function to render the featured whisper
        const renderFeaturedWhisper = (secret) => {
            if (!secret) {
                featuredWhisperContainer.classList.add('hidden');
                return;
            }
            
            // Show the featured whisper container
            featuredWhisperContainer.classList.remove('hidden');
            
            featuredWhisperCard.dataset.secretId = secret.id;
            
            let reactionButtonsHtml = emotions.map(emotion => {
                const count = secret.reactions[emotion.label] || 0;
                return `
                    <button
                        type="button"
                        data-emotion-label="${emotion.label}"
                        class="flex items-center px-3 py-2 rounded-full border-2 border-purple-500 bg-white/90 text-sm font-medium hover:bg-gray-200 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 shadow-sm hover:shadow-md transform hover:scale-105 active:scale-95"
                        title="React with ${emotion.label}"
                    >
                        <span class="text-xl mr-2">${emotion.emoji}</span>
                        <span class="text-gray-600 font-bold min-w-[20px] text-center">
                            ${count}
                        </span>
                    </button>
                `;
            }).join('');

            const totalReactions = getTotalReactions(secret);
            
            featuredWhisperCard.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <p class="text-xl font-bold text-purple-900 leading-snug flex-1 mr-4">
                        "${secret.secret}"
                    </p>
                    <span class="text-xs text-gray-600 whitespace-nowrap">
                        ${formatTime(secret.timestamp)}
                    </span>
                </div>
                <div class="flex flex-wrap gap-2 justify-center">
                    ${reactionButtonsHtml}
                </div>
                <div class="mt-4 text-center">
                    <span class="text-sm text-gray-700 font-semibold">
                        ${totalReactions} total reactions
                    </span>
                </div>
            `;
        };

        // Function to render all secrets to the page
        const renderSecrets = () => {
            const allSecrets = getWhispers();
            
            if (loadingStateElement) {
                loadingStateElement.classList.add('hidden');
            }
            
            if (allSecrets.length === 0) {
              if (emptyStateElement) emptyStateElement.classList.remove('hidden');
              if (featuredWhisperContainer) featuredWhisperContainer.classList.add('hidden');
              secretsContainer.innerHTML = '';
              if (whisperCountElement) whisperCountElement.textContent = `✨ 0 whispers shared so far`;
              return;
            } else {
              if (emptyStateElement) emptyStateElement.classList.add('hidden');
            }
            
            if (whisperCountElement) {
                whisperCountElement.textContent = `✨ ${allSecrets.length} whispers shared so far`;
            }

            // Find the featured whisper (the one with the most reactions)
            const sortedSecretsByReactions = [...allSecrets].sort((a, b) => getTotalReactions(b) - getTotalReactions(a));
            const featuredWhisper = sortedSecretsByReactions[0];
            
            renderFeaturedWhisper(featuredWhisper);

            // Filter out the featured whisper from the main list
            const remainingSecrets = allSecrets.filter(secret => secret.id !== featuredWhisper.id);
            
            secretsContainer.innerHTML = ''; // Clear only the main secrets container
            
            remainingSecrets.sort((a, b) => b.timestamp - a.timestamp);

            remainingSecrets.forEach((secret, index) => {
                const secretElement = document.createElement('div');
                secretElement.className = "group p-6 bg-white/60 backdrop-blur-sm rounded-xl shadow-lg border border-gray-300 hover:shadow-xl transition-all duration-300 hover:scale-[1.01]";
                secretElement.style.animationDelay = `${index * 0.1}s`;
                secretElement.style.animation = 'fadeIn 0.5s ease-out forwards';
                secretElement.dataset.secretId = secret.id;

                let reactionButtonsHtml = emotions.map(emotion => {
                    const count = secret.reactions[emotion.label] || 0;
                    return `
                        <button
                            type="button"
                            data-emotion-label="${emotion.label}"
                            class="flex items-center px-3 py-2 rounded-full border border-gray-400 bg-white/80 backdrop-blur-sm text-sm font-medium hover:bg-gray-200 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 shadow-sm hover:shadow-md transform hover:scale-105 active:scale-95"
                            title="React with ${emotion.label}"
                        >
                            <span class="text-lg mr-2">${emotion.emoji}</span>
                            <span class="text-gray-600 font-bold min-w-[20px] text-center">
                                ${count}
                            </span>
                        </button>
                    `;
                }).join('');

                const totalReactions = getTotalReactions(secret);

                secretElement.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <p class="text-lg text-gray-900 leading-relaxed flex-1 mr-4">
                            "${secret.secret}"
                        </p>
                        <span class="text-xs text-gray-500 whitespace-nowrap">
                            ${formatTime(secret.timestamp)}
                        </span>
                    </div>
                    <div class="flex flex-wrap gap-2 justify-center">
                        ${reactionButtonsHtml}
                    </div>
                    <div class="mt-3 text-center">
                        <span class="text-xs text-gray-500">
                            ${totalReactions} total reactions
                        </span>
                    </div>
                `;
                secretsContainer.appendChild(secretElement);
            });
        };

        const handleConfess = (e) => {
            e.preventDefault();
            const newSecretText = secretInput.value.trim();
            if (newSecretText === '') return;

            confessButton.disabled = true;
            confessButton.innerHTML = `<div class="flex items-center justify-center">
                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
                Sharing...
            </div>`;

            const secrets = getWhispers();
            const initialReactions = emotions.reduce((acc, emotion) => ({ ...acc, [emotion.label]: 0 }), {});
            const newId = Date.now().toString() + Math.random().toString(36).substr(2, 9);

            secrets.push({
                id: newId,
                secret: newSecretText,
                reactions: initialReactions,
                timestamp: Date.now(),
            });

            saveWhispers(secrets);
            renderSecrets();

            secretInput.value = '';
            charCounterElement.textContent = '0/500';
            confessButton.disabled = false;
            confessButton.innerHTML = `🤫 Confess Anonymously`;
        };

        const handleReaction = (e) => {
            const button = e.target.closest('[data-emotion-label]');
            if (!button) return;

            const emotionLabel = button.dataset.emotionLabel;
            const secretCard = button.closest('[data-secret-id]');
            const secretId = secretCard.dataset.secretId;

            if (!secretId) return;

            const secrets = getWhispers();
            const updatedSecrets = secrets.map(secret => {
                if (secret.id === secretId) {
                    const newReactions = { ...secret.reactions };
                    newReactions[emotionLabel] = (newReactions[emotionLabel] || 0) + 1;
                    return { ...secret, reactions: newReactions };
                }
                return secret;
            });

            saveWhispers(updatedSecrets);
            renderSecrets();
        };

        window.addEventListener('load', () => {
            renderSecrets();
            if (confessForm) confessForm.addEventListener('submit', handleConfess);
            if (secretsContainer) secretsContainer.addEventListener('click', handleReaction);
            if (secretInput) {
                secretInput.addEventListener('input', (e) => {
                    charCounterElement.textContent = `${e.target.value.length}/500`;
                });
                charCounterElement.textContent = `${secretInput.value.length}/500`;
            }
        });
    </script>
</body>
</html>
