<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whispers Online</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs for a real-time database (Firestore) and authentication -->
    <script type="module">
        // Import the necessary Firebase functions from the CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // NOTE: Removed `orderBy` as it can cause issues without a proper index
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment.
        // We use a defensive check to ensure they exist.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        let app;
        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            window.firebase = {}; // Initialize window.firebase here
        } else {
            console.error("Firebase config is missing. Please check your environment.");
            // You might want to handle this gracefully in the UI
            showErrorMessage("Error: Firebase configuration is missing. The app cannot connect to the database.");
        }
        
        const db = app ? getFirestore(app) : null;
        const auth = app ? getAuth(app) : null;

        let userId = null;
        let isAuthReady = false;
        let isInitialLoadComplete = false;

        // A function to show a custom error message
        const showErrorMessage = (message) => {
            const errorBox = document.getElementById('error-message-box');
            const errorText = document.getElementById('error-message-text');
            errorText.textContent = message;
            errorBox.classList.remove('hidden');
        };

        // Listen for authentication state changes
        if (auth) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is signed in.
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("User signed in with UID:", userId);
                    // Now that the user is authenticated, we can listen for whispers
                    if (window.initApp) {
                        window.initApp();
                    }
                } else {
                    // User is signed out. Attempt to sign in anonymously.
                    try {
                        if (initialAuthToken) {
                            // Use the provided custom auth token
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // Sign in anonymously if no token is available
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Error during anonymous sign-in:", error);
                        // Use the custom error message box instead of alert()
                        showErrorMessage("Error: Failed to connect to Firebase. Please check your network connection and try again.");
                    }
                }
            });
        } else {
            console.error("Firebase Auth is not available.");
            showErrorMessage("Error: Firebase Auth is not available. Please check your environment.");
        }

        // Expose Firebase objects to the global scope for use in the main script block
        if (window.firebase) {
            window.firebase = {
                db,
                auth,
                userId,
                isAuthReady,
                collection,
                doc,
                getDoc,
                addDoc,
                onSnapshot,
                updateDoc,
                serverTimestamp
            };
        }

        window.loadingState = {
            isInitialLoadComplete,
        };
    </script>

    <style>
        /* Custom animation for fading in new secrets */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-100 via-pink-100 to-blue-100 text-gray-800 font-sans p-4 sm:p-8 flex flex-col items-center min-h-screen overflow-x-hidden">

    <!-- Custom Error Message Box -->
    <div id="error-message-box" class="hidden fixed top-4 left-1/2 -translate-x-1/2 z-50 p-4 bg-red-500 text-white rounded-lg shadow-xl max-w-sm w-full text-center">
        <p id="error-message-text" class="font-semibold"></p>
        <button onclick="document.getElementById('error-message-box').classList.add('hidden')" class="mt-2 text-sm underline opacity-80 hover:opacity-100">Dismiss</button>
    </div>

    <!-- Main content container with responsive width and centered layout -->
    <div class="w-full max-w-3xl mx-auto my-4 sm:my-8 space-y-8">
        
        <!-- Header Section -->
        <div class="text-center p-6 bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl border border-gray-200">
            <h1 class="text-5xl font-extrabold mb-2 bg-gradient-to-r from-purple-500 to-pink-500 bg-clip-text text-transparent drop-shadow-lg">
                Whispers Online
            </h1>
            <p class="text-gray-600 text-lg">Share your secret anonymously and see how others react.</p>
            <div id="whisper-count" class="mt-2 text-sm text-gray-500">
                ‚ú® Loading whispers...
            </div>
        </div>

        <!-- Confession Form -->
        <form id="confess-form" class="p-6 bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl border border-gray-200">
            <div class="relative">
                <textarea
                    id="secret-input"
                    class="w-full p-4 rounded-xl border-2 border-gray-300 bg-white/50 backdrop-blur-sm text-base text-gray-900 focus:outline-none focus:ring-2 focus:ring-purple-400 focus:border-transparent transition-all duration-200 resize-none placeholder-gray-400"
                    placeholder="What's weighing on your heart? Share it anonymously..."
                    rows="4"
                    required
                    maxLength="500"
                ></textarea>
                <div id="char-counter" class="absolute bottom-2 right-2 text-xs text-gray-500">
                    0/500
                </div>
            </div>
            <button
                id="confess-button"
                type="submit"
                class="w-full mt-4 px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold rounded-xl hover:from-purple-600 hover:to-pink-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all duration-200 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-[1.02] active:scale-[0.98]"
            >
                ü§´ Confess Anonymously
            </button>
        </form>
        
        <!-- Recent Whispers Section -->
        <div>
            <h2 class="text-3xl font-bold mb-6 text-center bg-gradient-to-r from-gray-700 to-gray-900 bg-clip-text text-transparent drop-shadow-sm">
                Recent Whispers
            </h2>
            
            <!-- This is where the secrets will be injected by JavaScript -->
            <div id="secrets-container" class="space-y-6">
                <!-- A loading state while fetching data -->
                <div id="loading-state" class="text-center text-gray-500 py-12">
                  <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-400 mx-auto"></div>
                  <p class="mt-4">Loading whispers...</p>
                </div>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="text-center text-gray-500 py-12 hidden">
              <div class="text-6xl mb-4">ü§ê</div>
              <p class="text-xl">No secrets yet.</p>
              <p class="text-sm mt-2">Be the first to share your whisper!</p>
            </div>
        </div>

        <!-- Rules and Guidelines Section -->
        <div class="p-6 bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl border border-gray-200">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">üìú Guidelines for a Safe Community</h2>
            <ul class="list-disc list-inside space-y-2 text-gray-600">
                <li>Be kind and empathetic in your reactions.</li>
                <li>All whispers are anonymous. Please respect each other's privacy.</li>
                <li>No hate speech, threats, or explicit content.</li>
                <li>This is a safe space for honest sharing.</li>
            </ul>
        </div>
        
        <!-- Donation and Footer -->
        <div class="text-center text-sm text-gray-500 pt-6 border-t border-gray-300">
            <div class="my-4">
                <!--
                  The PayPal link has been updated with your username 'arccanimo'.
                  The QR code image is also the one you provided earlier.
                -->
                <a href="https://www.paypal.com/paypalme/arccanimo" target="_blank" class="inline-block w-full max-w-[200px] rounded-xl overflow-hidden shadow-lg transition-all duration-300 transform hover:scale-105">
                    <img 
                        src="https://raw.githubusercontent.com/Domus-negotii/anonymous-secrets/main/paypal-qr.png.png" 
                        alt="PayPal QR Code for donations"
                        class="w-full h-auto object-cover"
                    >
                </a>
                <p class="mt-4 text-sm text-gray-600">Scan or click to support this anonymous platform</p>
            </div>
            <p>üí´ All whispers are anonymous and ephemeral</p>
            <p class="mt-1">Share your truth, find your peace</p>
        </div>
    </div>

    <script>
        // Define the data and DOM elements
        const emotions = [
            { emoji: '‚ù§Ô∏è', label: 'Love' },
            { emoji: 'üòÇ', label: 'Laugh' },
            { emoji: 'üò¢', label: 'Sad' },
            { emoji: 'üôè', label: 'Care' },
            { emoji: 'üòÆ', label: 'Surprise' },
        ];
        
        const confessForm = document.getElementById('confess-form');
        const secretInput = document.getElementById('secret-input');
        const confessButton = document.getElementById('confess-button');
        const secretsContainer = document.getElementById('secrets-container');
        const whisperCountElement = document.getElementById('whisper-count');
        const emptyStateElement = document.getElementById('empty-state');
        const loadingStateElement = document.getElementById('loading-state');
        const charCounterElement = document.getElementById('char-counter');

        // Function to format the timestamp
        const formatTime = (timestamp) => {
            const now = Date.now();
            const diff = now - timestamp;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            return `${Math.floor(diff / 86400000)}d ago`;
        };

        // Function to render all secrets to the page
        const renderSecrets = (secrets) => {
            // Check if initial load is complete, and if not, hide loading state
            if (!window.loadingState.isInitialLoadComplete) {
                loadingStateElement.classList.add('hidden');
                window.loadingState.isInitialLoadComplete = true;
            }
            secretsContainer.innerHTML = ''; // Clear existing secrets
            
            whisperCountElement.textContent = `‚ú® ${secrets.length} whispers shared so far`;

            if (secrets.length === 0) {
              emptyStateElement.classList.remove('hidden');
            } else {
              emptyStateElement.classList.add('hidden');
              secrets.forEach((secret, index) => {
                  const secretElement = document.createElement('div');
                  secretElement.className = "group p-6 bg-white/60 backdrop-blur-sm rounded-xl shadow-lg border border-gray-300 hover:shadow-xl transition-all duration-300 hover:scale-[1.01]";
                  secretElement.style.animationDelay = `${index * 0.1}s`;
                  secretElement.style.animation = 'fadeIn 0.5s ease-out forwards';
                  secretElement.dataset.secretId = secret.id;

                  let reactionButtonsHtml = emotions.map(emotion => {
                      const count = secret.reactions[emotion.label] || 0;
                      return `
                          <button
                              type="button"
                              data-emotion-label="${emotion.label}"
                              class="flex items-center px-3 py-2 rounded-full border border-gray-400 bg-white/80 backdrop-blur-sm text-sm font-medium hover:bg-gray-200 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 shadow-sm hover:shadow-md transform hover:scale-105 active:scale-95"
                              title="React with ${emotion.label}"
                          >
                              <span class="text-lg mr-2">${emotion.emoji}</span>
                              <span class="text-gray-600 font-bold min-w-[20px] text-center">
                                  ${count}
                              </span>
                          </button>
                      `;
                  }).join('');

                  const totalReactions = Object.values(secret.reactions).reduce((a, b) => a + b, 0);

                  secretElement.innerHTML = `
                      <div class="flex justify-between items-start mb-4">
                          <p class="text-lg text-gray-900 leading-relaxed flex-1 mr-4">
                              "${secret.secret}"
                          </p>
                          <span class="text-xs text-gray-500 whitespace-nowrap">
                              ${formatTime(secret.timestamp)}
                          </span>
                      </div>
                      <div class="flex flex-wrap gap-2 justify-center">
                          ${reactionButtonsHtml}
                      </div>
                      <div class="mt-3 text-center">
                          <span class="text-xs text-gray-500">
                              ${totalReactions} total reactions
                          </span>
                      </div>
                  `;
                  secretsContainer.appendChild(secretElement);
              });
            }
        };

        // Handle form submission for a new secret
        const handleConfess = async (e) => {
            e.preventDefault(); // Prevent page refresh
            
            const newSecretText = secretInput.value.trim();
            if (newSecretText === '') return;

            confessButton.disabled = true;
            confessButton.innerHTML = `<div class="flex items-center justify-center">
                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
                Sharing...
            </div>`;

            try {
                // Get a reference to the 'whispers' collection in Firestore
                const whispersCollection = firebase.collection(firebase.db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'public', 'data', 'whispers');

                const initialReactions = emotions.reduce((acc, emotion) => ({ ...acc, [emotion.label]: 0 }), {});

                await firebase.addDoc(whispersCollection, {
                    secret: newSecretText,
                    reactions: initialReactions,
                    timestamp: firebase.serverTimestamp(),
                });
                
                secretInput.value = ''; // Clear the input field
                charCounterElement.textContent = '0/500';
            } catch (error) {
                console.error("Error adding document: ", error);
            } finally {
                confessButton.disabled = false;
                confessButton.innerHTML = `ü§´ Confess Anonymously`;
            }
        };

        // Handle a user clicking an emotion button
        const handleReaction = async (e) => {
            const button = e.target.closest('[data-emotion-label]');
            if (!button) return;
            
            // Correctly access the dataset property
            const emotionLabel = button.dataset.emotionLabel;
            const secretCard = button.closest('[data-secret-id]');
            const secretId = secretCard.dataset.secretId;
            
            if (!secretId) return;

            try {
                // Get the document reference
                const docRef = firebase.doc(firebase.db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'public', 'data', 'whispers', secretId);
                
                // Fetch the current document state
                const docSnap = await firebase.getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const currentReactions = data.reactions || {};
                    const newReactionCount = (currentReactions[emotionLabel] || 0) + 1;
                    
                    // Update the document with the new reaction count
                    await firebase.updateDoc(docRef, {
                        [`reactions.${emotionLabel}`]: newReactionCount
                    });
                }
            } catch (error) {
                console.error("Error updating document: ", error);
            }
        };

        // This function runs once the Firebase authentication is ready.
        window.initApp = function() {
            if (!window.firebase || !window.firebase.db) {
                console.error("Firebase is not available. Cannot initialize app.");
                return;
            }

            console.log("Firebase is ready. Initializing app functionality.");
            
            // Set a timeout to handle potential connection issues
            const loadingTimeout = setTimeout(() => {
                if (!window.loadingState.isInitialLoadComplete) {
                    loadingStateElement.innerHTML = `<p class="text-center text-red-500 py-12">Connection timed out. Please check your network and try reloading the page.</p>`;
                }
            }, 10000); // 10 seconds

            // Get a reference to the 'whispers' collection in Firestore
            const whispersCollection = firebase.collection(firebase.db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'public', 'data', 'whispers');
            
            // Set up a real-time listener for the collection
            const unsubscribe = firebase.onSnapshot(whispersCollection, (snapshot) => {
                console.log("onSnapshot fired! Number of documents:", snapshot.size);
                // Clear the timeout once we get a snapshot
                clearTimeout(loadingTimeout);

                const secrets = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Ensure timestamp is a valid number, handling serverTimestamp() delay
                    const timestamp = data.timestamp ? data.timestamp.toMillis() : Date.now(); 
                    secrets.push({
                        id: doc.id,
                        ...data,
                        timestamp: timestamp
                    });
                });

                // Sort the secrets by timestamp in descending order before rendering
                secrets.sort((a, b) => b.timestamp - a.timestamp);
                
                renderSecrets(secrets);
            }, (error) => {
                console.error("Error getting real-time updates: ", error);
                loadingStateElement.innerHTML = `<p class="text-center text-red-500 py-12">Failed to load whispers. Error: ${error.message}</p>`;
            });
            
            // Add event listeners once Firebase is ready
            confessForm.addEventListener('submit', handleConfess);
            secretsContainer.addEventListener('click', handleReaction);
            secretInput.addEventListener('input', (e) => {
              charCounterElement.textContent = `${e.target.value.length}/500`;
            });
        };

        // Initial setup for character counter
        window.addEventListener('load', () => {
            // Check if Firebase is already initialized
            if (window.firebase && window.firebase.isAuthReady) {
                window.initApp();
            }
            charCounterElement.textContent = `${secretInput.value.length}/500`;
        });
    </script>
</body>
</html>
